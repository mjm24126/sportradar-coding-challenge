# Instructions to Run
1. configure profile for environment you want to deploy to and set provider.profile accordingly.
2. update StepFunction resource definition with appropriate account number in lambda, role ARNs
3. `serverless deploy --stage dev`
4. run `../scripts/setupDatabaseLambdaPermissions.sh`  this configuration should be moved to resource template so it happens automatically in the future.
5. manually updated rds security group rules to ensure comminication is allowed between database and lambda functions. this configuration should also be moved to resource template so it happens automatically in the future.
    - add inbound rule: 	IPv4	PostgreSQL	TCP	5432	0.0.0.0/0
    - add outbound rule: 	IPv4	HTTPS	    TCP	443	    0.0.0.0/0	–
6. manually update each function's index.ts file after deployment changes to database connection properties, step function ARN. This should
    be reconfigured so those values are pulled from the stack and parameterized to avoid needing to change them.


# Resources
 - Lambdas: 
   - getGameData - gets all player stats for a game
   - ingestGameData - called from step function to update a game's live player stats
   - ingestInitialGameData - called from step function to initially insert a game's live player stats and player details
   - startIngestionStepFunction - called from database trigger to start an execution of the step function for a specified game
 - Endpoint:
   - GET - https://cfs2izg5xg.execute-api.us-east-1.amazonaws.com/dev/game/{gameId}
     - calls getGameData function to retrieve all player stats for game: {gameId}
     - https://cfs2izg5xg.execute-api.us-east-1.amazonaws.com can be replaced with the stack output's ServiceEndpoint
 - Database:
   - RDS Postgres instance NHLGameStats
 - Step Function:
   - GameStatIngesterStateMachine - continuously calls live game stats endpoint and updates database with all player game stats
    - note* - the definition for this step function has hardcoded lambda values within it. When deploying to another account, these will
                need to be updated to the appropriate account number. A future enhancement would be updating that definition statement to pull
                the arn's of the lambdas being deployed by the stack and parameterizing things like account number and region so they can be set 
                in one place instead of throughout the definition
            - the role for this step function was created in the console. Need to move to resources section of serverless app. it has much more wide
                open permissions then it needs. This was done as a time saving measure for the purposes of this exercise and would be cleaned up to 
                limit to only necessary permissions


# Query API 
  - API gateway endpoint that runs the getGameData function
  - https://cfs2izg5xg.execute-api.us-east-1.amazonaws.com/dev/game/{gameId} - returns array of player data and their stats for game <gameId>


# Tests
`npm test`


# With more time list
- credential storage. Use Secrets Manager or some other method for protecting database credentials
- utilize typescript classes for a lot more of the lambda and getGameStatusService code
- use logger library
- lock down iam permissions better
- use variable lambada arns in step function template (lambdas need to exist in order to use template currently)
- add swagger doc or some kind of endpoint documentation tool


... start of autogenerated documentation ...


# Serverless - AWS Node.js Typescript

This project has been generated using the `aws-nodejs-typescript` template from the [Serverless framework](https://www.serverless.com/).

For detailed instructions, please refer to the [documentation](https://www.serverless.com/framework/docs/providers/aws/).

## Installation/deployment instructions

Depending on your preferred package manager, follow the instructions below to deploy your project.

> **Requirements**: NodeJS `lts/fermium (v.14.15.0)`. If you're using [nvm](https://github.com/nvm-sh/nvm), run `nvm use` to ensure you're using the same Node version in local and in your lambda's runtime.

### Using NPM

- Run `npm i` to install the project dependencies
- Run `npx sls deploy` to deploy this stack to AWS

### Using Yarn

- Run `yarn` to install the project dependencies
- Run `yarn sls deploy` to deploy this stack to AWS

## Test your service

This template contains a single lambda function triggered by an HTTP request made on the provisioned API Gateway REST API `/hello` route with `POST` method. The request body must be provided as `application/json`. The body structure is tested by API Gateway against `src/functions/hello/schema.ts` JSON-Schema definition: it must contain the `name` property.

- requesting any other path than `/hello` with any other method than `POST` will result in API Gateway returning a `403` HTTP error code
- sending a `POST` request to `/hello` with a payload **not** containing a string property named `name` will result in API Gateway returning a `400` HTTP error code
- sending a `POST` request to `/hello` with a payload containing a string property named `name` will result in API Gateway returning a `200` HTTP status code with a message saluting the provided name and the detailed event processed by the lambda

> :warning: As is, this template, once deployed, opens a **public** endpoint within your AWS account resources. Anybody with the URL can actively execute the API Gateway endpoint and the corresponding lambda. You should protect this endpoint with the authentication method of your choice.

### Locally

In order to test the hello function locally, run the following command:

- `npx sls invoke local -f hello --path src/functions/hello/mock.json` if you're using NPM
- `yarn sls invoke local -f hello --path src/functions/hello/mock.json` if you're using Yarn

Check the [sls invoke local command documentation](https://www.serverless.com/framework/docs/providers/aws/cli-reference/invoke-local/) for more information.

### Remotely

Copy and replace your `url` - found in Serverless `deploy` command output - and `name` parameter in the following `curl` command in your terminal or in Postman to test your newly deployed application.

```
curl --location --request POST 'https://myApiEndpoint/dev/hello' \
--header 'Content-Type: application/json' \
--data-raw '{
    "name": "Frederic"
}'
```

## Template features

### Project structure

The project code base is mainly located within the `src` folder. This folder is divided in:

- `functions` - containing code base and configuration for your lambda functions
- `libs` - containing shared code base between your lambdas

```
.
├── src
│   ├── functions               # Lambda configuration and source code folder
│   │   ├── hello
│   │   │   ├── handler.ts      # `Hello` lambda source code
│   │   │   ├── index.ts        # `Hello` lambda Serverless configuration
│   │   │   ├── mock.json       # `Hello` lambda input parameter, if any, for local invocation
│   │   │   └── schema.ts       # `Hello` lambda input event JSON-Schema
│   │   │
│   │   └── index.ts            # Import/export of all lambda configurations
│   │
│   └── libs                    # Lambda shared code
│       └── apiGateway.ts       # API Gateway specific helpers
│       └── handlerResolver.ts  # Sharable library for resolving lambda handlers
│       └── lambda.ts           # Lambda middleware
│
├── package.json
├── serverless.ts               # Serverless service file
├── tsconfig.json               # Typescript compiler configuration
├── tsconfig.paths.json         # Typescript paths
└── webpack.config.js           # Webpack configuration
```

### 3rd party libraries

- [json-schema-to-ts](https://github.com/ThomasAribart/json-schema-to-ts) - uses JSON-Schema definitions used by API Gateway for HTTP request validation to statically generate TypeScript types in your lambda's handler code base
- [middy](https://github.com/middyjs/middy) - middleware engine for Node.Js lambda. This template uses [http-json-body-parser](https://github.com/middyjs/middy/tree/master/packages/http-json-body-parser) to convert API Gateway `event.body` property, originally passed as a stringified JSON, to its corresponding parsed object
- [@serverless/typescript](https://github.com/serverless/typescript) - provides up-to-date TypeScript definitions for your `serverless.ts` service file

### Advanced usage

Any tsconfig.json can be used, but if you do, set the environment variable `TS_NODE_CONFIG` for building the application, eg `TS_NODE_CONFIG=./tsconfig.app.json npx serverless webpack`
